<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ancestry Results Editor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 40px;
      color: #333;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border: 1px solid #ddd;
      padding: 20px 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    h1 {
      margin-top: 0;
      font-size: 22px;
      font-weight: 600;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .controls button {
      background: #0077ff;
      color: white;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
    }

    .controls button.secondary {
      background: #555;
    }

    .controls button.danger {
      background: #cc0000;
    }

    .ancestry-group {
      border-top: 1px solid #eee;
      padding-top: 10px;
      margin-top: 15px;
    }

    .ancestry-group:first-of-type {
      border-top: none;
      margin-top: 0;
    }

    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .group-header .name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      flex: 1;
    }

    .group-header .percentage {
      color: #666;
      font-size: 14px;
      width: 60px;
      text-align: right;
    }

    .subregion {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-left: 20px;
      padding: 4px 0;
    }

    .subregion .name {
      color: #555;
      flex: 1;
      font-size: 14px;
    }

    .subregion .percentage {
      color: #666;
      width: 60px;
      text-align: right;
      font-size: 14px;
    }

    .actions {
      display: flex;
      gap: 5px;
    }

    .actions button {
      background: none;
      border: none;
      color: #999;
      font-size: 16px;
      cursor: pointer;
      padding: 0 3px;
    }

    .actions button:hover {
      color: #333;
    }

    .total {
      margin-top: 20px;
      font-weight: bold;
      font-size: 15px;
    }

    .warning {
      color: red;
      font-size: 13px;
      margin-top: 5px;
    }

    /* View mode hides edit controls */
    body.view-mode .actions,
    body.view-mode .controls {
      display: none !important;
    }

    /* Prevent rounding */
    * {
      border-radius: 0 !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ancestry Composition</h1>
    <div class="controls">
      <button id="addCategoryBtn">+ Add Category</button>
      <button id="saveBtn">Save</button>
      <button id="resetBtn" class="danger">Reset</button>
      <button id="toggleEditBtn" class="secondary">Hide Edit Controls</button>
    </div>
    <div id="ancestryList"></div>
    <div class="total" id="totalDisplay">Total: 0%</div>
    <div class="warning" id="warning"></div>
  </div>

  <script>
    const ancestryList = document.getElementById('ancestryList');
    const totalDisplay = document.getElementById('totalDisplay');
    const warning = document.getElementById('warning');
    const toggleEditBtn = document.getElementById('toggleEditBtn');
    const resetBtn = document.getElementById('resetBtn');

    let editVisible = true;

    toggleEditBtn.addEventListener('click', () => {
      editVisible = !editVisible;
      document.body.classList.toggle('view-mode', !editVisible);
      toggleEditBtn.innerText = editVisible ? 'Hide Edit Controls' : 'Show Edit Controls';
      // Disable inline editing in view mode
      document.querySelectorAll('[contenteditable]').forEach(el => {
        el.setAttribute('contenteditable', editVisible);
      });
    });

    let data = JSON.parse(localStorage.getItem('ancestryData')) || [
      {
        name: "European",
        percentage: 60,
        subregions: [
          { name: "Northwestern European", percentage: 40 },
          { name: "Southern European", percentage: 20 }
        ]
      },
      {
        name: "East Asian",
        percentage: 25,
        subregions: [
          { name: "Chinese", percentage: 15 },
          { name: "Korean", percentage: 10 }
        ]
      },
      {
        name: "Sub-Saharan African",
        percentage: 15,
        subregions: [
          { name: "West African", percentage: 10 },
          { name: "East African", percentage: 5 }
        ]
      }
    ];

    function render() {
      ancestryList.innerHTML = '';
      data.forEach((group, i) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'ancestry-group';

        const header = document.createElement('div');
        header.className = 'group-header';
        header.innerHTML = `
          <div class="name" contenteditable="true" oninput="updateGroupName(${i}, this.innerText)">${group.name}</div>
          <div class="percentage" contenteditable="true" oninput="updateGroupPercent(${i}, this.innerText)">${group.percentage}%</div>
          <div class="actions">
            <button onclick="addSubregion(${i})">＋</button>
            <button onclick="removeGroup(${i})">×</button>
          </div>
        `;
        groupDiv.appendChild(header);

        group.subregions.forEach((sub, j) => {
          const subDiv = document.createElement('div');
          subDiv.className = 'subregion';
          subDiv.innerHTML = `
            <div class="name" contenteditable="true" oninput="updateSubName(${i}, ${j}, this.innerText)">${sub.name}</div>
            <div class="percentage" contenteditable="true" oninput="updateSubPercent(${i}, ${j}, this.innerText)">${sub.percentage}%</div>
            <div class="actions"><button onclick="removeSubregion(${i}, ${j})">×</button></div>
          `;
          groupDiv.appendChild(subDiv);
        });

        ancestryList.appendChild(groupDiv);
      });

      updateTotal();
    }

    function updateGroupName(i, val) {
      data[i].name = val.trim();
    }

    function updateGroupPercent(i, val) {
      data[i].percentage = parseFloat(val) || 0;
      updateTotal();
    }

    function updateSubName(i, j, val) {
      data[i].subregions[j].name = val.trim();
    }

    function updateSubPercent(i, j, val) {
      data[i].subregions[j].percentage = parseFloat(val) || 0;
      updateTotal();
    }

    function addSubregion(i) {
      data[i].subregions.push({ name: "New Subregion", percentage: 0 });
      render();
    }

    function removeSubregion(i, j) {
      data[i].subregions.splice(j, 1);
      render();
    }

    function removeGroup(i) {
      data.splice(i, 1);
      render();
    }

    document.getElementById('addCategoryBtn').addEventListener('click', () => {
      data.push({ name: "New Category", percentage: 0, subregions: [] });
      render();
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      localStorage.setItem('ancestryData', JSON.stringify(data));
      alert('Saved!');
    });

    resetBtn.addEventListener('click', () => {
      if (confirm("Are you sure you want to reset all ancestry data?")) {
        data = [];
        localStorage.removeItem('ancestryData');
        render();
      }
    });

    function updateTotal() {
      const total = data.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
      totalDisplay.innerText = `Total: ${total}%`;
      warning.innerText = total !== 100 ? "⚠️ Total should equal 100%." : "";
    }

    render();
  </script>
</body>
</html>
